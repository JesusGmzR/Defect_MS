<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Defectos OQC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
  <div id="app" class="container-fluid">
    <header class="modern-header">
      <div class="header-content">
        <div class="d-flex align-items-center">
          <div class="logo-container">
            <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
              <rect width="40" height="40" rx="8" fill="#333"/>
              <path d="M12 20L18 26L28 16" stroke="white" stroke-width="2" fill="none"/>
            </svg>
          </div>
          <h1 class="header-title">View Defects</h1>
        </div>
        <div class="header-controls">
          <button class="btn-menu">
            <i class="bi bi-list"></i>
            Menu
          </button>
        </div>
      </div>
    </header>

    <div class="main-layout">
      <!-- Layout de tres columnas -->
      <div class="three-column-layout">


        <!-- Columna 3: Escáner QR -->
        <div class="scanner-column">
          <div class="section-card">
            <h2 class="section-title">Scan defect event</h2>
            
            <!-- Estado de la cámara -->
            <div v-if="!cameraReady && !cameraInitializing" class="camera-status">
              <p>{{ cameraStatus }}</p>
              <button class="btn btn-primary" @click="inicializarEscanerQR">
                <i class="bi bi-camera-fill me-2"></i>Activar Cámara
              </button>
            </div>

            <!-- Inicializando cámara -->
            <div v-if="cameraInitializing" class="camera-status">
              <p>{{ cameraStatus }}</p>
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </div>
            
            <!-- Área de cámara simplificada con html5-qrcode -->
            <div class="camera-container" v-if="cameraReady">
              <div id="qr-reader" style="width: 100%;"></div>
              
              <!-- Botón Switch Camera - solo icono en esquina superior derecha -->
              <button class="btn-switch-camera" @click="switchCamera" v-if="availableCameras.length > 1" title="Cambiar cámara">
                <i class="bi bi-arrow-repeat"></i>
              </button>

              <!-- Resultado del escaneo automático - sutil -->
              <div class="scan-result-mini" v-if="scannedCode">
                <i class="bi bi-check-circle-fill"></i>
                <span>{{ scannedCode }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Columna 1: Filtros -->
        <div class="filters-column">
          <div class="section-card">
            <h2 class="section-title">Filters</h2>
            
            <!-- Filtros superiores -->
            <div class="filters-row">
              <div class="filter-group">
                <label class="filter-label">Material ID</label>
                <input 
                  type="text" 
                  class="filter-input" 
                  :class="{ 'scanned-input': scannedCode }" 
                  v-model="filtros.materialId" 
                  placeholder="Enter Material ID">
              </div>
              <div class="filter-group">
                <label class="filter-label">Defect reason</label>
                <select class="filter-select" v-model="filtros.defectReason">
                  <option value="">Select an option</option>
                  <option value="Reason 1">Reason 1</option>
                  <option value="Reason 2">Reason 2</option>
                  <option value="Reason 3">Reason 3</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Status</label>
                <select class="filter-select" v-model="filtros.status">
                  <option value="">Select an option</option>
                  <option value="New">New</option>
                  <option value="Updated">Updated</option>
                  <option value="Closed">Closed</option>
                </select>
              </div>
            </div>

            <!-- Filtros de fecha -->
            <div class="date-filters">
              <div class="filter-group">
                <label class="filter-label">From</label>
                <input type="date" class="filter-input" v-model="filtros.fechaInicio">
              </div>
              <div class="filter-group">
                <label class="filter-label">To</label>
                <input type="date" class="filter-input" v-model="filtros.fechaFin">
              </div>
            </div>
          </div>
        </div>

        <!-- Columna 2: Tabla de Defectos -->
        <div class="table-column">
          <div class="section-card">
            <h2 class="section-title">Defects List</h2>
            
            <!-- Tabla de defectos -->
            <div class="defects-table-container">
              <table class="defects-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Material ID</th>
                    <th>Reported date</th>
                    <th>Reason</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(defecto, index) in defectosFiltrados" 
                      :key="index" 
                      :class="{'selected-row': selectedDefect === index}"
                      @click="selectDefect(index, defecto)">
                    <td>{{ defecto.id }}</td>
                    <td>{{ defecto.materialId }}</td>
                    <td>{{ formatFecha(defecto.fecha) }}</td>
                    <td>{{ defecto.defecto }}</td>
                    <td><span class="status-badge" :class="'status-' + defecto.status.toLowerCase()">{{ defecto.status }}</span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        

              
      </div>

      <!-- Botones de acción -->
      <div class="action-buttons">
        <button class="btn-action btn-log-defect" @click="logDefect">
          <i class="bi bi-exclamation-triangle"></i>
          Log Defect
        </button>
        <button class="btn-action btn-view-manage" @click="viewManage">
          <i class="bi bi-eye"></i>
          View / Manage
        </button>
      </div>
    </div>



    <!-- Modal para mensajes -->
    <div class="modal fade" id="mensajeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" :class="{'bg-success': mensajeModal.tipo === 'exito', 'bg-danger': mensajeModal.tipo === 'error'}">
            <h5 class="modal-title text-white">{{ mensajeModal.titulo }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <span v-text="mensajeModal.mensaje"></span>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Librería moderna y confiable para escaneo de códigos QR -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="js/app.js"></script>
</body>
</html>